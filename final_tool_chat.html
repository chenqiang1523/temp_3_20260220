<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ÂØπËØùÂä©Êâã - Â∑•ÂÖ∑Â¢ûÂº∫Áâà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .new-chat-btn:hover {
            background: #0056b3;
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.3s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-item:hover {
            background: #f1f3f5;
        }

        .conversation-item.active {
            background: #e6f0ff;
            color: #007bff;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            padding: 20px 0 10px;
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chat-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin: 0 20px 20px;
        }

        .chat-header {
            background: #007bff;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 15px;
            border-radius: 18px;
            line-height: 1.5;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        .tool-call-message {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .tool-result-message {
            background: #d4edda;
            border: 1px solid #c3e6c8;
            color: #155724;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            font-family: monospace;
            font-size: 0.9em;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background: #007bff;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .ai-message {
            background: #f1f3f5;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .ai-error-message {
            background: #f8d7da;
            color: #721c24;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .typing-indicator {
            background: #f1f3f5;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            padding: 15px;
            display: none;
        }

        .typing-indicator span {
            height: 10px;
            width: 10px;
            float: left;
            margin: 0 2px;
            background-color: #9E9EA1;
            display: block;
            border-radius: 50%;
            opacity: 0.4;
        }

        .typing-indicator span:nth-of-type(1) {
            animation: typing 1s infinite;
        }

        .typing-indicator span:nth-of-type(2) {
            animation: typing 1s infinite 0.2s;
        }

        .typing-indicator span:nth-of-type(3) {
            animation: typing 1s infinite 0.4s;
        }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .input-area {
            display: flex;
            padding: 20px;
            background: white;
            border-top: 1px solid #eee;
        }

        .input-area input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            outline: none;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .input-area input:focus {
            border-color: #007bff;
        }

        .input-area button {
            margin-left: 10px;
            padding: 15px 25px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }

        .input-area button:hover {
            background: #0056b3;
        }

        .input-area button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .delete-conversation {
            color: #dc3545;
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.8rem;
        }

        .save-status {
            text-align: center;
            color: #28a745;
            font-size: 0.8rem;
            margin-top: 5px;
            height: 1.2rem;
        }

        .tool-badge {
            background: #ffc107;
            color: #856404;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.7em;
            margin-left: 5px;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 80px;
                padding: 10px 5px;
            }

            .conversation-title {
                display: none;
            }

            .new-chat-btn span {
                display: none;
            }

            .new-chat-btn::before {
                content: '+';
                font-size: 1.2rem;
            }

            .main-content {
                margin-left: 10px;
            }

            header h1 {
                font-size: 1.5rem;
            }

            .message {
                max-width: 90%;
            }

            .input-area {
                flex-direction: column;
                gap: 10px;
            }

            .input-area input {
                margin-bottom: 10px;
            }

            .input-area button {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <button class="new-chat-btn" id="new-chat-btn"><span>Êñ∞Âª∫ÂØπËØù</span></button>
        <div class="conversations-list" id="conversations-list">
            <!-- ÂØπËØùÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
        </div>
    </div>

    <div class="main-content">
        <header>
            <h1>ü§ñ AI ÂØπËØùÂä©Êâã</h1>
            <p>ÊµÅÂºèËæìÂá∫ ‚Ä¢ Â∑•ÂÖ∑ÈõÜÊàê ‚Ä¢ Ê∞∏‰πÖ‰øùÂ≠ò</p>
        </header>

        <div class="chat-container">
            <div class="chat-header">
                <span id="current-chat-title">Êñ∞ÂØπËØù</span>
                <span class="delete-conversation" id="delete-current-chat">Âà†Èô§</span>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="message ai-message">
                    ‰Ω†Â•ΩÔºÅÊàëÊòØAIÂä©ÊâãÔºåÊîØÊåÅÊµÅÂºèËæìÂá∫ÂíåÂ∑•ÂÖ∑Ë∞ÉÁî®„ÄÇÊàëÂèØ‰ª•‰ΩøÁî®Âä†Ê≥ïÂ∑•ÂÖ∑Êù•Â∏ÆÂä©‰Ω†ËÆ°ÁÆóÊï∞Â≠¶ÈóÆÈ¢ò„ÄÇ
                </div>
            </div>
            <div class="typing-indicator" id="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="input-area">
                <input type="text" id="user-input" placeholder="ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò... (‰æãÂ¶Ç: ËÆ°ÁÆó 5 + 3)" autocomplete="off">
                <button id="send-button">ÂèëÈÄÅ</button>
            </div>
            <div class="save-status" id="save-status"></div>
        </div>
    </div>

    <script>
        // AI ÂØπËØùÂäüËÉΩÂÆûÁé∞ - ÊîØÊåÅÊµÅÂºèËæìÂá∫ÂíåÂ∑•ÂÖ∑Ë∞ÉÁî®
        class AIChatService {
            constructor(apiKey, model = 'deepseek-chat') {
                this.apiKey = apiKey;
                this.model = model;
                this.baseUrl = 'https://api.deepseek.com';
            }

            async sendMessageStream(message, history = [], onChunk, onToolCall = null) {
                try {
                    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅË∞ÉÁî®Â∑•ÂÖ∑
                    const toolCallInfo = this.checkForToolCall(message);
                    
                    if (toolCallInfo && onToolCall) {
                        // ÊâßË°åÂ∑•ÂÖ∑Ë∞ÉÁî®
                        const toolResult = await this.executeTool(toolCallInfo);
                        
                        // Â∞ÜÂ∑•ÂÖ∑Ë∞ÉÁî®ÂíåÁªìÊûúÊ∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
                        const updatedHistory = [
                            ...history,
                            { role: 'user', content: message },
                            { 
                                role: 'assistant', 
                                content: `Ê≠£Âú®Ë∞ÉÁî®${toolCallInfo.name}Â∑•ÂÖ∑`,
                                tool_calls: [{
                                    id: `call_${Date.now()}`,
                                    type: 'function',
                                    function: {
                                        name: toolCallInfo.name,
                                        arguments: JSON.stringify(toolCallInfo.arguments)
                                    }
                                }]
                            },
                            {
                                role: 'tool',
                                content: JSON.stringify({ result: toolResult }),
                                tool_call_id: `call_${Date.now()}`
                            }
                        ];
                        
                        // ÈÄöÁü•Â§ñÈÉ®Â∑•ÂÖ∑Ë∞ÉÁî®‰ø°ÊÅØ
                        onToolCall(toolCallInfo, toolResult);
                        
                        // ‰ΩøÁî®Êõ¥Êñ∞ÂêéÁöÑÂéÜÂè≤ËÆ∞ÂΩïÂÜçÊ¨°Ë∞ÉÁî®AI
                        return await this.sendMessageStream('', updatedHistory, onChunk, null);
                    }
                    
                    const response = await fetch(`${this.baseUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.apiKey}`
                        },
                        body: JSON.stringify({
                            model: this.model,
                            messages: [
                                ...history,
                                { role: 'user', content: message }
                            ],
                            stream: true
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        
                        if (done) {
                            break;
                        }

                        const chunk = decoder.decode(value, { stream: true });
                        buffer += chunk;
                        
                        // ÂàÜÂâ≤ÂèØËÉΩÁöÑÂ§ö‰∏™Êï∞ÊçÆÂùó
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // ‰øùÁïô‰∏çÂÆåÊï¥ÁöÑË°å

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const dataStr = line.slice(6);
                                
                                if (dataStr === '[DONE]') {
                                    break;
                                }

                                try {
                                    const data = JSON.parse(dataStr);
                                    
                                    if (data.choices && data.choices[0]) {
                                        const delta = data.choices[0].delta;
                                        
                                        if (delta && delta.content) {
                                            onChunk(delta.content);
                                        }
                                    }
                                } catch (e) {
                                    // ÂøΩÁï•Ëß£ÊûêÈîôËØØ
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('AIÊµÅÂºèËØ∑Ê±ÇÈîôËØØ:', error);
                    throw error;
                }
            }

            checkForToolCall(message) {
                // Ê£ÄÊµãÂä†Ê≥ïÂ∑•ÂÖ∑Ë∞ÉÁî®
                const addPattern = /(\d+(?:\.\d+)?)\s*[+]\s*(\d+(?:\.\d+)?)/;
                const match = message.match(addPattern);
                
                if (match) {
                    return {
                        name: 'add',
                        arguments: {
                            a: parseFloat(match[1]),
                            b: parseFloat(match[2])
                        }
                    };
                }
                
                // Ê£ÄÊµã"ËÆ°ÁÆó"ÂÖ≥ÈîÆËØç
                const calcPattern = /ËÆ°ÁÆó|Âä†Ê≥ï|Ê±ÇÂíå|sum|Âä†‰∏ä|Áõ∏Âä†|Á≠â‰∫é/i;
                if (calcPattern.test(message)) {
                    // Â∞ùËØïÊèêÂèñÊï∞Â≠ó
                    const numbers = message.match(/\d+(?:\.\d+)?/g);
                    if (numbers && numbers.length >= 2) {
                        return {
                            name: 'add',
                            arguments: {
                                a: parseFloat(numbers[0]),
                                b: parseFloat(numbers[1])
                            }
                        };
                    }
                }
                
                return null;
            }

            async executeTool(toolCallInfo) {
                if (toolCallInfo.name === 'add') {
                    const { a, b } = toolCallInfo.arguments;
                    const result = a + b;
                    return result;
                }
                
                return 'Êú™Áü•Â∑•ÂÖ∑';
            }
        }

        // ÂØπËØùÁÆ°ÁêÜÁ±ª
        class ConversationManager {
            constructor() {
                this.conversations = this.loadConversations();
                this.currentConversationId = null;
            }

            createNewConversation(title = 'Êñ∞ÂØπËØù') {
                const conversationId = `conv_${Date.now()}`;
                this.conversations[conversationId] = {
                    title: title,
                    messages: [],
                    timestamp: Date.now()
                };
                this.currentConversationId = conversationId;
                this.saveConversations();
                return conversationId;
            }

            switchConversation(conversationId) {
                if (this.conversations[conversationId]) {
                    this.currentConversationId = conversationId;
                    return true;
                }
                return false;
            }

            deleteConversation(conversationId) {
                if (this.conversations[conversationId]) {
                    delete this.conversations[conversationId];
                    if (this.currentConversationId === conversationId) {
                        this.currentConversationId = null;
                    }
                    this.saveConversations();
                    return true;
                }
                return false;
            }

            addMessage(conversationId, role, content, extra = {}) {
                if (this.conversations[conversationId]) {
                    const messageObj = {
                        role,
                        content,
                        timestamp: Date.now(),
                        ...extra
                    };
                    
                    this.conversations[conversationId].messages.push(messageObj);
                    this.conversations[conversationId].timestamp = Date.now();
                    
                    // Â¶ÇÊûúËøôÊòØÁ¨¨‰∏Ä‰∏™Ê∂àÊÅØÔºåÊõ¥Êñ∞ÂØπËØùÊ†áÈ¢ò
                    if (this.conversations[conversationId].messages.length === 1 && role === 'user') {
                        this.conversations[conversationId].title = content.substring(0, 30) + (content.length > 30 ? '...' : '');
                    }
                    
                    this.saveConversations();
                }
            }

            getConversation(conversationId) {
                return this.conversations[conversationId] || null;
            }

            getAllConversations() {
                // ÊåâÊó∂Èó¥Êà≥ÊéíÂ∫èÔºåÊúÄÊñ∞ÁöÑÂú®Ââç
                return Object.entries(this.conversations)
                    .sort((a, b) => b[1].timestamp - a[1].timestamp)
                    .map(([id, conv]) => ({ id, ...conv }));
            }

            getCurrentConversation() {
                if (this.currentConversationId) {
                    return this.getConversation(this.currentConversationId);
                }
                return null;
            }

            getCurrentConversationId() {
                return this.currentConversationId;
            }

            loadConversations() {
                const saved = localStorage.getItem('ai_conversations');
                return saved ? JSON.parse(saved) : {};
            }

            saveConversations() {
                localStorage.setItem('ai_conversations', JSON.stringify(this.conversations));
            }
        }

        class AIChatApp {
            constructor() {
                this.currentConversationId = null;
                this.conversations = this.loadConversations();
                this.apiKey = 'sk-cea233d8fefd49c38f9585a9108f132a';
                this.model = 'deepseek-chat';
                this.baseUrl = 'https://api.deepseek.com';

                this.initializeElements();
                this.initializeServices();
                this.initializeEventListeners();
                this.renderConversationsList();
                
                // Â¶ÇÊûúÊ≤°ÊúâÂØπËØùÔºåÂàôÂàõÂª∫‰∏Ä‰∏™Êñ∞ÂØπËØù
                if (Object.keys(this.conversations).length === 0) {
                    this.createNewConversation();
                } else {
                    // Âä†ËΩΩÊúÄËøëÁöÑÂØπËØù
                    const conversationIds = Object.keys(this.conversations);
                    if (conversationIds.length > 0) {
                        this.switchToConversation(conversationIds[0]);
                    }
                }
            }

            initializeElements() {
                this.conversationsList = document.getElementById('conversations-list');
                this.chatMessages = document.getElementById('chat-messages');
                this.userInput = document.getElementById('user-input');
                this.sendButton = document.getElementById('send-button');
                this.typingIndicator = document.getElementById('typing-indicator');
                this.newChatBtn = document.getElementById('new-chat-btn');
                this.currentChatTitle = document.getElementById('current-chat-title');
                this.deleteCurrentChatBtn = document.getElementById('delete-current-chat');
                this.saveStatus = document.getElementById('save-status');
            }

            initializeServices() {
                this.conversationManager = new ConversationManager();
                this.aiService = new AIChatService(this.apiKey, this.model);
            }

            initializeEventListeners() {
                this.sendButton.addEventListener('click', () => this.handleSendMessage());
                this.userInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.handleSendMessage();
                    }
                });
                this.newChatBtn.addEventListener('click', () => this.createNewConversation());
                this.deleteCurrentChatBtn.addEventListener('click', () => this.deleteCurrentConversation());
            }

            async handleSendMessage() {
                const message = this.userInput.value.trim();
                if (!message || !this.conversationManager.getCurrentConversationId()) return;

                // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞ËÅäÂ§©ËÆ∞ÂΩï
                this.addMessageToChat(message, 'user');
                this.userInput.value = '';
                this.showTypingIndicator();

                try {
                    // Ëé∑ÂèñÂΩìÂâçÂØπËØùÁöÑÂéÜÂè≤Ê∂àÊÅØ
                    const currentConv = this.conversationManager.getCurrentConversation();
                    const history = currentConv ? currentConv.messages.filter(msg => 
                        msg.role !== 'system' && !msg.is_temporary
                    ) : [];

                    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂ∑•ÂÖ∑Ë∞ÉÁî®
                    const toolCallInfo = this.aiService.checkForToolCall(message);
                    
                    if (toolCallInfo) {
                        // ÊâßË°åÂ∑•ÂÖ∑Ë∞ÉÁî®
                        const toolResult = await this.aiService.executeTool(toolCallInfo);
                        
                        // ÊòæÁ§∫Â∑•ÂÖ∑Ë∞ÉÁî®‰ø°ÊÅØ
                        this.addMessageToChat(`Ê≠£Âú®Ë∞ÉÁî® ${toolCallInfo.name} Â∑•ÂÖ∑: a=${toolCallInfo.arguments.a}, b=${toolCallInfo.arguments.b}`, 'tool-call-message');
                        
                        // ÊòæÁ§∫Â∑•ÂÖ∑ÁªìÊûú
                        this.addMessageToChat(`Â∑•ÂÖ∑ÁªìÊûú: ${toolResult}`, 'tool-result-message');
                        
                        // Ê∑ªÂä†Â∑•ÂÖ∑Ë∞ÉÁî®ÂíåÁªìÊûúÂà∞ÂéÜÂè≤
                        const currentId = this.conversationManager.getCurrentConversationId();
                        if (currentId) {
                            this.conversationManager.addMessage(currentId, 'assistant', `Ë∞ÉÁî®${toolCallInfo.name}Â∑•ÂÖ∑`, {
                                tool_calls: [{
                                    id: `call_${Date.now()}`,
                                    type: 'function',
                                    function: {
                                        name: toolCallInfo.name,
                                        arguments: JSON.stringify(toolCallInfo.arguments)
                                    }
                                }]
                            });
                            
                            this.conversationManager.addMessage(currentId, 'tool', JSON.stringify({ result: toolResult }), {
                                tool_call_id: `call_${Date.now()}`
                            });
                        }
                        
                        // ÂÜçÊ¨°Ë∞ÉÁî®AIËé∑ÂèñÊúÄÁªàÂõûÂ§ç
                        let aiResponse = '';
                        await this.aiService.sendMessageStream('', [...history, 
                            { role: 'user', content: message },
                            { 
                                role: 'assistant', 
                                content: `Ë∞ÉÁî®${toolCallInfo.name}Â∑•ÂÖ∑`,
                                tool_calls: [{
                                    id: `call_${Date.now()}`,
                                    type: 'function',
                                    function: {
                                        name: toolCallInfo.name,
                                        arguments: JSON.stringify(toolCallInfo.arguments)
                                    }
                                }]
                            },
                            {
                                role: 'tool',
                                content: JSON.stringify({ result: toolResult }),
                                tool_call_id: `call_${Date.now()}`
                            }
                        ], (chunk) => {
                            aiResponse += chunk;
                            
                            // Â¶ÇÊûúAIÊ∂àÊÅØÂÖÉÁ¥†Ëøò‰∏çÂ≠òÂú®ÔºåÂàõÂª∫‰∏Ä‰∏™
                            if (!this.aiMessageElement) {
                                this.aiMessageElement = document.createElement('div');
                                this.aiMessageElement.className = 'message ai-message';
                                this.chatMessages.appendChild(this.aiMessageElement);
                                this.scrollToBottom();
                            }
                            
                            // Êõ¥Êñ∞AIÊ∂àÊÅØÂÜÖÂÆπ
                            this.aiMessageElement.textContent = aiResponse;
                            this.scrollToBottom();
                        });
                        
                        // Ê∑ªÂä†AIÊúÄÁªàÂõûÂ§çÂà∞ÂéÜÂè≤
                        if (currentId) {
                            this.conversationManager.addMessage(currentId, 'assistant', aiResponse);
                        }
                        
                        // Ê∏ÖÈô§‰∏¥Êó∂ÁöÑAIÊ∂àÊÅØÂÖÉÁ¥†ÂºïÁî®
                        delete this.aiMessageElement;
                    } else {
                        // Ê≤°ÊúâÂ∑•ÂÖ∑Ë∞ÉÁî®ÔºåÁõ¥Êé•Ëé∑ÂèñAIÂõûÂ§ç
                        let aiResponse = '';
                        await this.aiService.sendMessageStream(message, history, (chunk) => {
                            aiResponse += chunk;
                            
                            // Â¶ÇÊûúAIÊ∂àÊÅØÂÖÉÁ¥†Ëøò‰∏çÂ≠òÂú®ÔºåÂàõÂª∫‰∏Ä‰∏™
                            if (!this.aiMessageElement) {
                                this.aiMessageElement = document.createElement('div');
                                this.aiMessageElement.className = 'message ai-message';
                                this.chatMessages.appendChild(this.aiMessageElement);
                                this.scrollToBottom();
                            }
                            
                            // Êõ¥Êñ∞AIÊ∂àÊÅØÂÜÖÂÆπ
                            this.aiMessageElement.textContent = aiResponse;
                            this.scrollToBottom();
                        });
                        
                        // Ê∑ªÂä†AIÂõûÂ§çÂà∞ÂéÜÂè≤
                        const currentId = this.conversationManager.getCurrentConversationId();
                        if (currentId) {
                            this.conversationManager.addMessage(currentId, 'assistant', aiResponse);
                        }
                        
                        // Ê∏ÖÈô§‰∏¥Êó∂ÁöÑAIÊ∂àÊÅØÂÖÉÁ¥†ÂºïÁî®
                        delete this.aiMessageElement;
                    }
                    
                    this.hideTypingIndicator();
                    this.conversationManager.saveConversations();
                    this.showSaveStatus('ÂØπËØùÂ∑≤‰øùÂ≠ò');
                } catch (error) {
                    this.hideTypingIndicator();
                    this.addMessageToChat(`Êä±Ê≠âÔºåÂá∫Áé∞ÈîôËØØ: ${error.message}`, 'ai-error');
                }
            }

            addMessageToChat(content, sender) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', `${sender}-message`);
                messageElement.textContent = content;
                this.chatMessages.appendChild(messageElement);
                this.scrollToBottom();
            }

            showTypingIndicator() {
                this.typingIndicator.style.display = 'block';
                this.sendButton.disabled = true;
                this.scrollToBottom();
            }

            hideTypingIndicator() {
                this.typingIndicator.style.display = 'none';
                this.sendButton.disabled = false;
            }

            scrollToBottom() {
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            createNewConversation() {
                const newId = this.conversationManager.createNewConversation();
                this.currentConversationId = newId;
                this.clearChatDisplay();
                this.addMessageToChat('‰Ω†Â•ΩÔºÅÊàëÊòØAIÂä©ÊâãÔºåÊîØÊåÅÊµÅÂºèËæìÂá∫ÂíåÂ∑•ÂÖ∑Ë∞ÉÁî®„ÄÇÊàëÂèØ‰ª•‰ΩøÁî®Âä†Ê≥ïÂ∑•ÂÖ∑Êù•Â∏ÆÂä©‰Ω†ËÆ°ÁÆóÊï∞Â≠¶ÈóÆÈ¢ò„ÄÇ', 'ai');
                this.renderConversationsList();
                this.updateCurrentChatTitle();
            }

            switchToConversation(conversationId) {
                this.conversationManager.switchConversation(conversationId);
                this.renderChatMessages();
                this.updateCurrentChatTitle();
                this.renderConversationsList();
            }

            deleteCurrentConversation() {
                const currentId = this.conversationManager.getCurrentConversationId();
                if (currentId) {
                    this.conversationManager.deleteConversation(currentId);
                    const conversations = this.conversationManager.getAllConversations();
                    if (conversations.length > 0) {
                        this.conversationManager.switchConversation(conversations[0].id);
                        this.renderChatMessages();
                        this.updateCurrentChatTitle();
                    } else {
                        // Â¶ÇÊûúÊ≤°ÊúâÂØπËØù‰∫ÜÔºåÂàõÂª∫‰∏Ä‰∏™Êñ∞ÂØπËØù
                        this.createNewConversation();
                    }
                    this.renderConversationsList();
                }
            }

            renderConversationsList() {
                this.conversationsList.innerHTML = '';
                
                // ÊåâÊó∂Èó¥Êà≥ÊéíÂ∫èÂØπËØùÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
                const sortedConversations = this.conversationManager.getAllConversations();

                sortedConversations.forEach(conv => {
                    const item = document.createElement('div');
                    item.classList.add('conversation-item');
                    if (conv.id === this.conversationManager.getCurrentConversationId()) {
                        item.classList.add('active');
                    }
                    
                    item.innerHTML = `
                        <div class="conversation-title">${conv.title}</div>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 3px;">
                            ${new Date(conv.timestamp).toLocaleDateString()}
                        </div>
                    `;
                    
                    item.addEventListener('click', () => this.switchToConversation(conv.id));
                    this.conversationsList.appendChild(item);
                });
            }

            renderChatMessages() {
                this.clearChatDisplay();
                
                const currentConv = this.conversationManager.getCurrentConversation();
                
                if (!currentConv || currentConv.messages.length === 0) {
                    this.addMessageToChat('ÂºÄÂßãÊñ∞ÁöÑÂØπËØùÂêßÔºÅÊàëÂèØ‰ª•Â∏Æ‰Ω†ËøõË°åÊï∞Â≠¶ËÆ°ÁÆó„ÄÇ', 'ai');
                    return;
                }

                currentConv.messages.forEach(message => {
                    if (message.role === 'user') {
                        this.addMessageToChat(message.content, 'user');
                    } else if (message.role === 'assistant') {
                        if (message.tool_calls) {
                            // ÊòæÁ§∫Â∑•ÂÖ∑Ë∞ÉÁî®‰ø°ÊÅØ
                            message.tool_calls.forEach(call => {
                                this.addMessageToChat(`Ê≠£Âú®Ë∞ÉÁî® ${call.function.name} Â∑•ÂÖ∑: ${call.function.arguments}`, 'tool-call-message');
                            });
                        } else {
                            this.addMessageToChat(message.content, 'ai');
                        }
                    } else if (message.role === 'tool') {
                        try {
                            const toolData = JSON.parse(message.content);
                            this.addMessageToChat(`Â∑•ÂÖ∑ÁªìÊûú: ${toolData.result}`, 'tool-result-message');
                        } catch (e) {
                            this.addMessageToChat(`Â∑•ÂÖ∑ÁªìÊûú: ${message.content}`, 'tool-result-message');
                        }
                    }
                });
            }

            clearChatDisplay() {
                this.chatMessages.innerHTML = '';
            }

            updateCurrentChatTitle() {
                const currentConv = this.conversationManager.getCurrentConversation();
                if (currentConv) {
                    this.currentChatTitle.textContent = currentConv.title;
                } else {
                    this.currentChatTitle.textContent = 'Êñ∞ÂØπËØù';
                }
            }

            showSaveStatus(message) {
                this.saveStatus.textContent = message;
                setTimeout(() => {
                    this.saveStatus.textContent = '';
                }, 2000);
            }

            loadConversations() {
                const saved = localStorage.getItem('ai_conversations');
                return saved ? JSON.parse(saved) : {};
            }
        }

        // ÂàùÂßãÂåñÂ∫îÁî®
        document.addEventListener('DOMContentLoaded', () => {
            new AIChatApp();
        });
    </script>
</body>
</html>